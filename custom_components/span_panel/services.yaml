export_synthetic_config:
  name: Export Synthetic Sensor Config
  description: Export the current synthetic sensor configuration to a YAML file. You can specify either a directory (file will be named automatically) or a full file path.
  fields:
    directory:
      name: File Path
      description: Either a directory path (file will be named automatically) or a full file path ending in .yaml where the configuration will be saved.
      required: true
      example: "/config/span_panel_sensor_config.yaml"
      selector:
        text:

cleanup_energy_spikes:
  name: Cleanup Energy Spikes
  description: >
    IMPORTANT!  Perform a BACKUP and SAVE the dry run JSON. Detect and fix negative energy
    spikes from a specific SPAN panel's energy sensors caused by firmware updates or resets.
    Uses the main meter to detect reset timestamps where the cumulative energy value decreased.
    Adjusts the statistics sum values to restore continuity, eliminating spikes from the energy
    Dashboard. Only processes statistics within the specified time range.
    For each sensor, calculates the adjustment needed to fix the discontinuity. When available,
    also estimates missing energy during the gap by analyzing post-reset consumption rates,
    providing more accurate energy accounting.
  fields:
    config_entry_id:
      name: Panel Config Entry ID
      description: >
        The config entry ID of the SPAN panel to clean up.
      required: true
      selector:
        config_entry:
          integration: span_panel
    start_time:
      name: Start Time
      description: >
        Local start date and time for the time range to scan (down to seconds).
        The service automatically expands the query window by 1 hour before this time
        to ensure spikes at the exact start time can be detected (requires comparison
        with prior entry). Only spikes within the specified range will be processed.
      required: true
      selector:
        datetime:
    end_time:
      name: End Time
      description: >
        Local end date and time for the time range to scan (down to seconds).
        Can be equal to start_time to target a specific spike time.
        Only statistics within this time range will be processed.
      required: true
      selector:
        datetime:
    dry_run:
      name: Dry Run
      description: >
        Preview spikes without fixing. Returns list of detected spikes and adjustments.
        Defaults to true for safety - set to false to actually apply the corrections.
      required: false
      default: true
      selector:
        boolean:
    main_meter_entity_id:
      name: Main Meter Sensor (Optional)
      description: >
        The main meter energy sensor to use for spike detection. Must be a consumed
        or produced energy sensor (not net/calculated sensors). If not specified,
        auto-detects the main meter. Use if you have renamed sensors or auto-detection
        fails. Note: The dropdown shows all energy sensors but only consumed/produced
        sensors with TOTAL_INCREASING state class are valid. If an invalid sensor is
        selected, the error response will list valid sensors.
      required: false
      selector:
        entity:
          integration: span_panel
          domain: sensor
          device_class: energy

undo_stats_adjustments:
  name: Undo Statistics Adjustments
  description: >
    Undo statistics adjustments made by the cleanup_energy_spikes service OR create
    manual adjustments for testing. Can be used in three ways:
    1. Reverse applied cleanup (dry_run=false result): Provide cleanup_result JSON
       containing "adjustments" to undo all changes that were made.
    2. Reverse proposed cleanup (dry_run=true result): Provide cleanup_result JSON
       containing "details" to undo the changes that would have been made.
    3. Manual adjustment: Provide entity_id, reset_time, and optionally adjustment_wh
       to create a specific adjustment.
    WARNING: This modifies your statistics database. Use only for testing or to undo
    errant cleanup operations!
  fields:
    cleanup_result:
      name: Cleanup Result (JSON)
      description: >
        JSON result from cleanup_energy_spikes service. Accepts both dry_run=true
        and dry_run=false results. For dry_run=false results, reverses the applied
        adjustments. For dry_run=true results, reverses the proposed adjustments.
        Both effectively undo what cleanup did or would have done. Can be a JSON
        object or JSON string. When provided, entity_id and reset_time are not required.
      required: false
      selector:
        object:
    entity_id:
      name: Entity ID
      description: >
        The entity ID of the sensor to simulate a reset for (e.g., sensor.span_panel_main_meter_consumed_energy).
        Required only if cleanup_result is not provided.
      required: false
      selector:
        entity:
          domain: sensor
    reset_time:
      name: Reset Time
      description: >
        Local date and time when the reset should occur. The statistics sum at this time
        will be adjusted downward. Required only if cleanup_result is not provided.
      required: false
      selector:
        datetime:
    adjustment_wh:
      name: Adjustment +/- (Wh)
      description: >
        Adjustment amount in watt-hours. Positive values increase the sum, negative values decrease it.
        If not specified, drops to 0 (complete reset). The adjustment will propagate to all subsequent
        statistics entries. Only used when cleanup_result is not provided.
      required: false
      selector:
        number:
          step: 0.01
          unit_of_measurement: Wh
