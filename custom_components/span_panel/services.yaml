export_synthetic_config:
  name: Export Synthetic Sensor Config
  description: Export the current synthetic sensor configuration to a YAML file. You can specify either a directory (file will be named automatically) or a full file path.
  fields:
    directory:
      name: File Path
      description: Either a directory path (file will be named automatically) or a full file path ending in .yaml where the configuration will be saved.
      required: true
      example: "/config/span_panel_sensor_config.yaml"
      selector:
        text:

cleanup_energy_spikes:
  name: Cleanup Energy Spikes
  description: >
    IMPORTANT!  Perform a BACKUP and SAVE the dry run JSON. Detect and fix negative energy
    spikes from a specific SPAN panel's energy sensors caused by firmware updates or resets.
    Uses the main meter to detect reset timestamps where the cumulative energy value decreased.
    Adjusts the statistics sum values to restore continuity, eliminating spikes from the energy
    Dashboard without data loss. Only processes statistics within the specified time range.
    This works by looking for decreasing sum in the TOTAL_INCREASING main meter consumed
    energy and applies each sensor's difference between the reported value and previous
    higher value to during the spike time.
  fields:
    config_entry_id:
      name: Panel Config Entry ID
      description: >
        The config entry ID of the SPAN panel to clean up.
      required: true
      selector:
        config_entry:
          integration: span_panel
    start_time:
      name: Start Time
      description: >
        Local start date and time for the time range to scan (down to seconds).
        Only statistics within this time range will be processed.
      required: true
      selector:
        datetime:
    end_time:
      name: End Time
      description: >
        Local end date and time for the time range to scan (down to seconds).
        Must be after start_time. Only statistics within this time range will be processed.
      required: true
      selector:
        datetime:
    dry_run:
      name: Dry Run
      description: >
        Preview spikes without fixing. Returns list of detected spikes and adjustments.
        Defaults to true for safety - set to false to actually apply the corrections.
      required: false
      default: true
      selector:
        boolean:

undo_stats_adjustments:
  name: Undo Statistics Adjustments
  description: >
    Undo statistics adjustments made by the cleanup_energy_spikes service OR create
    manual adjustments for testing. Can be used in two ways:
    1. Reverse cleanup: Provide cleanup_result (JSON from cleanup_energy_spikes service)
       to undo all adjustments that were made, effectively restoring the original spikes.
    2. Manual adjustment: Provide entity_id, reset_time, and optionally drop_amount_wh
       to create a test adjustment scenario.
    WARNING: This modifies your statistics database. Use only for testing or to undo
    errant cleanup operations!
  fields:
    cleanup_result:
      name: Cleanup Result (JSON)
      description: >
        JSON result from cleanup_energy_spikes service to reverse. If provided,
        all adjustments from that cleanup operation will be reversed. This allows
        you to undo errant cleanup operations. Can be a JSON object or JSON string.
        When this is provided, entity_id and reset_time are not required.
      required: false
      selector:
        object:
    entity_id:
      name: Entity ID
      description: >
        The entity ID of the sensor to simulate a reset for (e.g., sensor.span_panel_main_meter_consumed_energy).
        Required only if cleanup_result is not provided.
      required: false
      selector:
        entity:
          domain: sensor
    reset_time:
      name: Reset Time
      description: >
        Local date and time when the reset should occur. The statistics sum at this time
        will be adjusted downward. Required only if cleanup_result is not provided.
      required: false
      selector:
        datetime:
    drop_amount_wh:
      name: Drop Amount (Wh)
      description: >
        Amount to drop in watt-hours. If not specified, drops to 0 (complete reset).
        The adjustment will propagate to all subsequent statistics entries.
        Only used when cleanup_result is not provided.
      required: false
      selector:
        number:
          min: 0
          step: 0.01
          unit_of_measurement: Wh
