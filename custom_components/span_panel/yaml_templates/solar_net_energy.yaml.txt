  {{sensor_key}}:
    name: "Solar Net Energy"
    entity_id: "{{entity_id}}"
    formula: {{net_consumed_entity_id}} - {{net_produced_entity_id}}
    alternate_states:
      FALLBACK:
        formula: "last_valid_state if is_within_grace_period else 'unknown'"
    variables:
      last_valid_state:
        formula: "metadata(state, 'last_valid_state')"
        alternate_states:
          FALLBACK: 'unknown'
      last_valid_changed:
        formula: "metadata(state, 'last_valid_changed')"
        alternate_states:
          FALLBACK: 'unknown'
      panel_status:
        formula: "{{panel_status_entity_id}}"
      panel_offline_minutes:
        formula: "minutes_between(metadata('{{panel_status_entity_id}}', 'last_changed'), utc_now()) if not panel_status else 0"
      is_within_grace_period:
        formula: "last_valid_state is not None and last_valid_state != 'unknown' and last_valid_changed != 'unknown' and not panel_status and panel_offline_minutes < energy_grace_period_minutes"
        alternate_states:
          FALLBACK: false
      leg1_consumed: {{leg1_consumed_entity}}
      leg2_consumed: {{leg2_consumed_entity}}

    attributes:
      tabs: "{{tabs_attribute}}"
      voltage: {{voltage_attribute}}
      grace_period_remaining:
        formula: "round(max(0, energy_grace_period_minutes - panel_offline_minutes), 1) if is_within_grace_period else 0"
        alternate_states:
          FALLBACK: 'N/A'
      energy_reporting_status:
        formula: "'Live' if state != 'unknown' else ('Off-Line, reporting previous value' if grace_period_remaining > 0 else 'unknown')"
        alternate_states:
          FALLBACK: false
      panel_offline_minutes_is:
        formula: "panel_offline_minutes"
        alternate_states:
          FALLBACK: 'unknown'
      is_within_grace_is:
        formula: "is_within_grace_period"
        alternate_states:
          FALLBACK: 'unknown'
    metadata:
      unit_of_measurement: "Wh"
      device_class: "energy"
      state_class: "total"
      suggested_display_precision: {{energy_display_precision}}
