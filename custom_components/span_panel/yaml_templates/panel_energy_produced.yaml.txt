  {{sensor_key}}:
    name: "{{sensor_name}}"
    entity_id: "{{entity_id}}"
    formula: state
    alternate_states:
      FALLBACK:
        formula: "last_valid_state if last_valid_state is not None and last_valid_state != 'unknown' and last_valid_changed != 'unknown' and minutes_between(last_valid_changed, now()) < energy_grace_period_minutes else 'unknown'"
    variables:
      last_valid_state:
        formula: "metadata(state, 'last_valid_state')"
      last_valid_changed:
        formula: "metadata(state, 'last_valid_changed')"

    attributes:
      tabs: "{{tabs_attribute}}"
      voltage: {{voltage_attribute}}
      grace_period_remaining:
        formula: "energy_grace_period_minutes - minutes_between(last_valid_changed, now()) if last_valid_changed != 'unknown' and minutes_between(last_valid_changed, now()) < energy_grace_period_minutes else 'N/A'"
        alternate_states:
          FALLBACK: 'N/A'
      energy_reporting_status:
        formula: "'Live' if state != 'unknown' else ('Off-Line, reporting previous value' if (last_valid_state is not None and last_valid_state != 'unknown' and last_valid_changed != 'unknown' and minutes_between(last_valid_changed, now()) < energy_grace_period_minutes) else 'unknown')"
        alternate_states:
          FALLBACK: false
    metadata:
      unit_of_measurement: "Wh"
      device_class: "energy"
      state_class: "total_increasing"
      suggested_display_precision: {{energy_display_precision}}
