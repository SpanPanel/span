  {{sensor_key}}:
    name: "Solar Produced Energy"
    entity_id: "{{entity_id}}"
    formula: leg1_produced + leg2_produced
    alternate_states:
      FALLBACK:
        formula: "state if state is not None else (last_valid_state if within_grace else None)"
    variables:
      leg1_produced: {{leg1_produced_entity}}
      leg2_produced: {{leg2_produced_entity}}
      last_valid_state:
        formula: "metadata(state, 'last_valid_state')"
      last_valid_changed:
        formula: "metadata(state, 'last_valid_changed')"
      within_grace:
        formula: "last_valid_changed is not None and minutes_between(last_valid_changed, now()) < energy_grace_period_minutes"
        alternate_states:
          FALLBACK: false
    attributes:
      tabs: "{{tabs_attribute}}"
      voltage: {{voltage_attribute}}
      energy_reporting_status:
        formula: "'Live' if state is not None else ('Off-Line, reporting previous value' if within_grace else None)"
        alternate_states:
          FALLBACK: false
    metadata:
      unit_of_measurement: "Wh"
      device_class: "energy"
      state_class: "total_increasing"
      suggested_display_precision: {{energy_display_precision}}
