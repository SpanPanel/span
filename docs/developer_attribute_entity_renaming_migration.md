# Synthetic Sensor Entity Renaming and Migration

## Background

Only a single renaming is supported: migrating legacy installations (pre-1.0.4 without a device prefix) to device-prefixed entity IDs while preserving the
existing entity_id tails. Post-install flipping between naming patterns (Friendly Names ↔ Circuit Numbers) is not supported in the UI. The goal is to preserve
entity history and user customizations without deleting/recreating entities.

## Goals

- Preserve Home Assistant entity history for synthetic sensors when renaming occurs.
- Retain user customizations (such as friendly names, device class, etc.) if the user has not manually changed the entity ID.
- Update entity IDs in YAML definitions only if the entity ID was not customized by the user.
- Safely migrate legacy installations (no device prefix) to device-prefixed naming while preserving existing tails, handling edge cases where user modifications
  exist.
- Exclude Panel sensors from migration except in the legacy device prefix migration case. Panel level circuits can be identifiedi through filter logic.
- Exclude User Customized Entity ID's from migration. The process for identifying a user customized entity_id is detailed below.

The options flow triggers a one-time legacy-to-prefix migration and then saves the updated options. Once entity_ids are migrated, a common routine is used to
modify the SensorSet storage via the synthetic package.

## Naming Policy (Post-Install Behavior)

- After initial install, the entity naming style is fixed. The options UI does not offer flipping between Friendly Names and Circuit Numbers.
- Supported migration path is limited to legacy installations (pre-1.0.4) that lacked a device prefix. These can migrate once to device-prefixed naming while
  preserving the existing entity_id tails (friendly/circuit text remains unchanged).
- This policy avoids repeated renames, preserves history, and removes the need for dual-calculation under different flag sets.

## Panel Level vs Named Circuits Filtering

Panel level circuits are those like the grid power or the mains current_power which apply to the entire panel. Since panel level circuits do not control an
individual numbered circuit, which is a combination of one or more tabs in the panel and they do not have a circuit ID in their sensor key/unique_id. A circuit
ID is a UUID generated by the panel and permanently assigned to a circuit so that adding circuits does not affect the other circuit ID's. Named individual
circuits returned by the panel API are circuits like those used to control individual circuit like a refrigerator.

For a device with device identifier span_sp3-simulation-001 sensor keys take this form:

- Panel circuits take the form without the circuit_id/UUID: `span_sp3-simulation-001_current_power`
- Named circuits will have a Sensor Key that contains this circuit_id/UUID: `span_sp3-simulation-001_12ce227695cd44338864b0ef2ec4168b_power`

## Information Extraction from YAML Export

From the `SensorSet.export()` YAML dump, extract:

**1. Suffix from entity_id:**

- Extract last part of entity_id (e.g., `sensor.span_panel_dining_room_wine_fridge_power` → `power`)
- Reverse map to API description key (`power` → `instantPowerW`)

**2. Circuit information from variables:**

- For solar sensors: parse variables (unmapped) to find leg1/leg2 circuit references
- For single-circuit sensors: find circuit backing entity to determine circuit_data
- For multi-circuit sensors: identify which circuits are being combined

**3. Friendly name from name field:**

- Use for solar sensors when calling `construct_solar_synthetic_entity_id()`

### Suffix to API Description Key Mapping

| Entity ID Suffix     | API Description Key | Description                      |
| -------------------- | ------------------- | -------------------------------- |
| `power`              | `instantPowerW`     | Current power consumption        |
| `energy_produced`    | `producedEnergyWh`  | Total energy produced            |
| `energy_consumed`    | `consumedEnergyWh`  | Total energy consumed            |
| `current_power`      | `instantGridPowerW` | Grid power (panel level)         |
| `feed_through_power` | `feedthroughPowerW` | Feed through power (panel level) |

### Developer Helper References (for tooling only)

The supported migration is prefix-only. The following helper-based generation approach is for development tooling and diagnostics; it is not used by the
supported user migration.

Use the composite helper function `construct_multi_tab_entity_id_from_key()` which automatically:

- Determines the appropriate sensor type (panel, multi-tab/240V, circuit-based)
- Extracts required parameters from sensor key and configuration
- Calls the correct specific helper function internally
- Handles all suffix mapping and parameter extraction

**Usage (dev tooling only):**

```python
new_entity_id = construct_multi_tab_entity_id_from_key(
    coordinator=coordinator,
    span_panel=span_panel,
    platform="sensor",
    sensor_key=sensor_key,
    sensor_config=sensor_config,
    unique_id=None,  # Skip registry during migration
)
```

**Internal Parameter Extraction (dev tooling only):**

The composite helper internally handles:

- **Suffix extraction**: Uses `get_suffix_from_sensor_key()` to extract suffix from sensor key
- **Sensor type detection**: Identifies panel, multi-tab/240V, or circuit sensors automatically
- **Multi-tab/240V information**: Extracts tab numbers and friendly names from sensor configuration
- **Circuit data**: Determines circuit numbers and friendly names as needed
- **API key mapping**: Handles any required suffix-to-API-key conversions

## Migration Steps

### A) Legacy → Device Prefix (Prefix-Only) Migration [Supported]

1. Export current YAML definitions for all synthetic sensors.
2. Determine the device prefix (slugified `config_entry.data["device_name"]` or `config_entry.title`).
3. For every sensor (panel, solar, circuit):
   - If its `entity_id` is not already prefixed, rewrite it as: `sensor.{device_prefix}_{old_tail}` where `{old_tail}` is the existing suffix portion after the
     platform (`sensor.`). Do not recompute the tail.
   - Build old→new mapping as you rewrite.
4. Update cross-references across the YAML using the mapping (find/replace in strings).
5. Use the synthetic package's `modify()` to persist changes.
6. Save new options (enable device prefix), then reload the integration.

Notes:

- Panel sensors are included in this legacy migration (they adopt the device prefix).
- User-customized entity_ids are preserved in their tail; only the device prefix is added if missing.

### B) Non-Legacy Pattern Flips (Friendly ↔ Circuit Numbers) [Not supported post-install]

- Post-install flipping is not supported in the options UI. If required for testing, install with the desired pattern instead.
- If a non-legacy migration must be computed (e.g., in development tooling), use `construct_multi_tab_entity_id_from_key()` under explicit flag overrides to
  compute the target entity_id, perform cross-reference updates, and persist via `modify()`.

## Technical Implementation Details

### Understanding Sensor Keys vs Entity IDs

**Sensor Keys:**

- Serve as unique identifiers in the synthetic package with format:
  - Panel sensors: `{device_id}_{suffix}` (e.g., `span_sp3-simulation-001_current_power`)
  - Circuit sensors: `{device_id}_{circuit_uuid}_{suffix}` (e.g., `span_sp3-simulation-001_12ce227695cd44338864b0ef2ec4168b_power`)
  - Solar sensors: `{device_id}_solar_{suffix}` (e.g., `span_sp3-simulation-001_solar_power`)
- Used primarily for:
  - Filtering logic to determine panel circuit vs normal named circuit (presence of UUID in sensor key)
  - Sensor type identification (solar detection using `solar` in sensor_key.lower())
  - As unique identifiers for synthetic package operations
- Sensor keys themselves are mostly irrelevant for parameter extraction

**Entity IDs:**

- Found in the `entity_id` field of sensor configs with format determined by configuration flags:
  - Friendly names: `sensor.span_panel_{friendly_name}_{suffix}` (e.g., `sensor.span_panel_dining_room_wine_fridge_power`)
  - Circuit numbers: `sensor.span_panel_circuit_{number}_{suffix}` (e.g., `sensor.span_panel_circuit_14_power`)
  - Solar sensors (friendly names): `sensor.span_panel_solar_inverter_{suffix}` (e.g., `sensor.span_panel_solar_inverter_power`)
  - Solar sensors (circuit numbers): `sensor.span_panel_circuit_{leg1}_{leg2}_{suffix}` (e.g., `sensor.span_panel_circuit_30_32_power`)
- Show the current naming pattern, not what the old or new patterns should be
- Used for extracting the suffix needed by helper functions
- **Helper functions automatically ensure Home Assistant entity ID compliance**:
  - The integration's helper functions use `slugify()` to convert circuit names and device names
  - Ensures valid entity IDs with only lowercase letters, numbers, and underscores

### Helper Function Requirements

- Helper functions expect API description keys, not user-friendly suffixes
- All entity IDs must be generated by helper functions
- Helper functions take parameters like `instantPowerW`, `producedEnergyWh`, `instantGridPowerW` (not user-friendly suffixes like `power`, `energy_produced`,
  `grid_power`)
- A reverse mapping from user-friendly suffix back to API description key is required (see table above)

### Helper Function Reference Table

| Function Type              | Helper Function                            | Usage Context                           | Output/Format                                                                                  |
| -------------------------- | ------------------------------------------ | --------------------------------------- | ---------------------------------------------------------------------------------------------- |
| **Entity ID Construction** |                                            |                                         |                                                                                                |
| **Panel Sensors**          | `construct_panel_entity_id()`              | Panel-level sensors (grid, mains, etc.) | `sensor.span_panel_{description}`                                                              |
| **Multi-tab/240V Sensors** | `construct_240v_synthetic_entity_id()`     | Multi-tab/240V synthetic sensors        | `sensor.span_panel_circuit_{tab1}_{tab2}_{suffix}`                                             |
| **Single Circuit**         | `construct_single_circuit_entity_id()`     | Individual circuit sensors              | `sensor.span_panel_{friendly_name}_{suffix}` or `sensor.span_panel_circuit_{number}_{suffix}`  |
| **Multi Circuit**          | `construct_multi_circuit_entity_id()`      | Combined circuit sensors                | `sensor.span_panel_{friendly_name}_{suffix}` or `sensor.span_panel_circuit_{numbers}_{suffix}` |
| **Backing/Raw**            | `construct_backing_entity_id()`            | Underlying SPAN API entities            | `sensor.span_panel_{circuit_name}_{suffix}`                                                    |
| **Unmapped**               | `construct_unmapped_entity_id()`           | Internal unmapped circuits (tabs)       | `sensor.span_panel_unmapped_tab_{number}_{suffix}`                                             |
| **General Purpose**        | `construct_entity_id()`                    | Legacy/general entity construction      | Variable format based on parameters                                                            |
| **From Sensor Key**        | `construct_multi_tab_entity_id_from_key()` | Convert sensor key to entity ID         | Variable format based on sensor type                                                           |
| **Suffix Utilities**       |                                            |                                         |                                                                                                |
| **Reverse Mapping**        | `get_api_description_key_from_suffix()`    | Convert entity ID suffix to API key     | `"power"` → `"instantPowerW"`                                                                  |
| **Forward Mapping**        | `get_user_friendly_suffix()`               | Convert API key to user-friendly suffix | `"instantPowerW"` → `"power"`                                                                  |
| **Panel Suffix**           | `get_panel_entity_suffix()`                | Convert panel API key to entity suffix  | `"instantGridPowerW"` → `"current_power"`                                                      |
| **Extract Suffix**         | `get_suffix_from_sensor_key()`             | Extract suffix from sensor key          | `"span_device_uuid_power"` → `"power"`                                                         |

### Helper Function Selection Guide

**For Migration Logic:**

1. **Use the composite helper**: `construct_multi_tab_entity_id_from_key()` handles all sensor types automatically
2. **Sensor type detection**: The helper internally identifies panel, multi-tab/240V, and circuit sensors from sensor keys
3. **Parameter extraction**: All required parameters are extracted automatically from sensor key and configuration

**Migration Implementation Pattern:**

```python
# Generate new entity ID with specified flags
new_entity_id = construct_multi_tab_entity_id_from_key(
    coordinator=coordinator,
    span_panel=span_panel,
    platform="sensor",
    sensor_key=sensor_key,
    sensor_config=sensor_config,
    unique_id=None,  # Skip registry during migration
)
```

**Internal Helper Selection:**

The composite helper automatically delegates to:

- **Panel sensors** → `construct_panel_entity_id()`
- **Multi-tab/240V sensors** → `construct_240v_synthetic_entity_id()`
- **Circuit sensors** → `construct_multi_circuit_entity_id()` (with extracted parameters)

**Key Utility Functions Available:**

- `get_suffix_from_sensor_key()` - Extract suffix from sensor key (used internally)
- `is_panel_level_sensor_key()` - Determine if sensor is panel-level (used for filtering)
- `is_solar_sensor_key()` - Identify solar sensors (used internally)
- `extract_solar_info_from_sensor_key()` - Extract solar parameters (used internally)

### Entity ID Validation Requirements

**Home Assistant Entity ID Rules:**

- Must contain only lowercase letters, numbers, and underscores: `[a-z0-9_]+`
- Cannot contain dashes, slashes, spaces, or special characters
- The integration uses `homeassistant.util.slugify()` to sanitize circuit names and device names

### Multi-tab/240V Sensor Examples

**Multi-tab/240V sensors for tabs 30/32 configuration:**

**Friendly Names Pattern (USE_DEVICE_PREFIX=True, USE_CIRCUIT_NUMBERS=False):**

```yaml
span_sp3-simulation-001_240v_power:
  name: 240V Current Power
  entity_id: sensor.span_panel_240v_power
  variables:
    tab1_power: sensor.span_panel_unmapped_tab_30_power
    tab2_power: sensor.span_panel_unmapped_tab_32_power
```

**Circuit Numbers Pattern (USE_DEVICE_PREFIX=True, USE_CIRCUIT_NUMBERS=True):**

```yaml
span_sp3-simulation-001_240v_power:
  name: 240V Current Power
  entity_id: sensor.span_panel_circuit_30_32_power
  variables:
    tab1_power: sensor.span_panel_unmapped_tab_30_power
    tab2_power: sensor.span_panel_unmapped_tab_32_power
```

Note: The sensor key remains the same (`span_sp3-simulation-001_240v_power`) regardless of naming pattern, only the `entity_id` changes.

## Common YAML Update Process

### 1. Update Entity IDs Only

- Only modify the `entity_id` field in sensor configs
- Leave everything else unchanged: `name`, `formula`, `variables`, `metadata`, `attributes`, etc.
- This preserves all user customizations except entity_id changes

### 2. Update Cross-References

- Scan entire YAML document for references to changed entity_ids
- Find/replace all occurrences of old entity_id with new entity_id throughout the document
- This handles cases where users have custom attribute formulas referencing other synthetic sensors, variables in one sensor referencing another synthetic
  sensor's entity_id, or any other cross-references in the configuration

### 3. Apply Changes

- Do not remove and recreate entities in Home Assistant
- Use the synthetic package's `modify()` routine to write the updated YAML definitions back to storage

### 4. Reload Integration

- Trigger a reload of the integration so that Home Assistant picks up the updated YAML and applies the new entity IDs

## Summary Table

| Case                                                             | Action Taken                                     |
| ---------------------------------------------------------------- | ------------------------------------------------ |
| Legacy (no prefix) migrating all sensors to prefix/friendly only | Update to device prefix friendly                 |
| Panel-level sensor (see filter, non-legacy)                      | Excluded from migration                          |
| User-customized entity ID (differs from expected, non-legacy)    | Excluded from migration                          |
| Non-legacy pattern flip (friendly ↔ circuit) post-install       | Not supported in UI (install with desired style) |

## Benefits

- Preserves entity history by renaming rather than deleting/recreating entities.
- Respects user customizations by only updating entity IDs that have not been changed by the user.
- Maintains integrity of cross-references between synthetic sensors.
- Ensures smooth migration between naming patterns, including legacy to modern transitions.

## Implementation Analysis

### Current Implementation vs Documentation

The migration implementation in `entity_id_naming_patterns.py` largely follows the documented approach with some key differences:

1. **Solar Information Extraction**: Verify that `extract_solar_info_from_sensor_key()` correctly identifies leg1/leg2 from sensor configuration variables

2. **Multi-Circuit Handling**: Ensure multi-circuit sensors are handled correctly with proper circuit number extraction from sensor configurations

3. **Legacy Migration Coverage**: Confirm that legacy migration includes all sensor types (panel, solar, circuit) as intended

### Validation Recommendations

To ensure full migration functionality:

1. **Test Solar Sensor Migration**: Verify leg1/leg2 extraction works correctly with real solar sensor configurations
2. **Validate Multi-Circuit Scenarios**: Test migration of sensors that combine multiple circuits
3. **Test Legacy Migration**: Verify comprehensive legacy migration handles all sensor types correctly
4. **Cross-Reference Validation**: Ensure entity ID references in formulas and variables are updated properly
